{% extends 'Base/base_section.html' %}
{% load static %}

{% block css %}
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.css"
          rel="stylesheet"/>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"
            type="text/javascript"></script>
{% endblock %}

{% block content %}

    <div class="main">

        {% if is_owner %}
            <div class="row">
                <div class="container">

                    {% if user_cars %}

                        <div class="main" style="padding: 50px 0 50px 0">
                            <div class="col s12 m7">
                                <div id="map"></div>
                                <div class="row">
                                    <div class="col s12">
                                        <br>
                                        <button class="waves-effect blue accent-2 btn" id="clean-btn">Borrar marcadores
                                        </button>
                                        <button class="waves-effect blue accent-2 btn" id="draw-btn">Trazar</button>
                                    </div>
                                </div>
                            </div>

                            <div class="col s12 m5">
                                <div class="row">
                                    <form action="" class="col s12" method="post">
                                        <div class="input-field col s12 m6">
                                            <select id="origen" name="origen">
                                                <option value="" disabled selected>Seleccione un origen de referencia
                                                </option>
                                                <option value="Centro"
                                                        {% if route.origin == "Centro" %}selected{% endif %}>Centro
                                                </option>
                                                <option value="Plaza"
                                                        {% if route.origin == "Plaza" %}selected{% endif %}>Plaza
                                                </option>
                                                <option value="Hogar"
                                                        {% if route.origin == "Hogar" %}selected{% endif %}>Hogar
                                                </option>
                                                <option value="Escuela"
                                                        {% if route.origin == "Escuela" %}selected{% endif %}>Escuela
                                                </option>
                                                <option value="Trabajo"
                                                        {% if route.origin == "Trabajo" %}selected{% endif %}>Trabajo
                                                </option>
                                            </select>
                                            <label>Origen</label>
                                        </div>

                                        <div class="input-field col s12 m6">
                                            <select id="destiny" name="destiny">
                                                <option value="0" disabled selected>Seleccione un destino</option>
                                                {% for campus in campus_list %}
                                                    <option value="{{ campus.pk }}"
                                                            {% if route.campus_pk == campus.pk %}selected{% endif %}>{{ campus.name }}</option>
                                                {% endfor %}
                                            </select>
                                            <label>Destino</label>
                                        </div>

                                        <div class="input-field col s12 m6">
                                            <select id="car" name="car">
                                                <option value="" disabled selected>Seleccione un vehiculo</option>
                                                {% for car in user_cars %}
                                                    <option value="{{ car.pk }}"
                                                            {% if route.car_pk == car.pk %}selected{% endif %}>{{ car.brand }} {{ car.model }}</option>
                                                {% endfor %}
                                            </select>
                                            <label>Vehiculo</label>
                                        </div>

                                        <div class="input-field col s12 m6">
                                            <select id="sits" name="sits">
                                                <option value="0" disabled selected>Seleccione un cupo</option>
                                                <option value="1" {% if route.sits == 1 %}selected{% endif %}>1</option>
                                                <option value="2" {% if route.sits == 2 %}selected{% endif %}>2</option>
                                                <option value="3" {% if route.sits == 3 %}selected{% endif %}>3</option>
                                                <option value="4" {% if route.sits == 4 %}selected{% endif %}>4</option>
                                            </select>
                                            <label>Cupo</label>
                                        </div>
                                        <div class="12u 12u(mobilep)" style="display: -webkit-inline-box;">
                                            <label for="total_sits">Cuota de recuperación $:</label> &nbsp;
                                            <input type="number" min="0" name="recovery" id="recovery"
                                                   value=""/>
                                        </div>
                                        <div class="col s3" align="center">
                                            <label>Seleccione los días de la ruta</label>
                                            <p>
                                                <input id="lunes" value="Lunes" name="dia[]" type="checkbox"
                                                        {% for day in route_days %}
                                                       {% if day.day == "Lunes" %}checked{% endif %} {% endfor %}/>
                                                <label for="lunes">Lunes</label>
                                            </p>
                                            <p>
                                                <input id="martes" value="Martes" name="dia[]" type="checkbox"
                                                        {% for day in route_days %}
                                                       {% if day.day == "Martes" %}checked{% endif %} {% endfor %}/>
                                                <label for="martes">Martes</label>
                                            </p>
                                            <p>
                                                <input id="miercoles" value="Miercoles" name="dia[]" type="checkbox"
                                                        {% for day in route_days %}
                                                       {% if day.day == "Miercoles" %}checked{% endif %} {% endfor %}/>
                                                <label for="miercoles">Miercoles</label>
                                            </p>
                                            <p>
                                                <input id="jueves" value="Jueves" name="dia[]" type="checkbox"
                                                        {% for day in route_days %}
                                                       {% if day.day == "Jueves" %}checked{% endif %} {% endfor %}/>
                                                <label for="jueves">Jueves</label>
                                            </p>
                                            <p>
                                                <input id="viernes" value="Viernes" name="dia[]" type="checkbox"
                                                        {% for day in route_days %}
                                                       {% if day.day == "Viernes" %}checked{% endif %} {% endfor %}/>
                                                <label for="viernes">Viernes</label>
                                            </p>
                                            <p>
                                                <input id="sabado" value="Sabado" name="dia[]" type="checkbox"
                                                        {% for day in route_days %}
                                                       {% if day.day == "Sabado" %}checked{% endif %} {% endfor %}/>
                                                <label for="sabado">Sábado</label>
                                            </p>
                                            <br>
                                        </div>
                                        <div class="col s4" align="center">
                                            <label>Horario de inicio.</label>
                                            <div class='input-group date' id='datetimepicker3'>
                                                <input id="hora" type='text' name="hora" class="form-control"
                                                       value="{{ route.start_time }}"/>
                                                <span class="input-group-addon">
                        <span class="glyphicon glyphicon-time"></span>
                    </span>
                                            </div>
                                        </div>
                                        <br>
                                        <div class="col s12" align="center">
                                            <button id="guardar-btn" class="btn waves-effect blue accent-2"
                                                    type="button"
                                                    name="action">Guardar
                                                <i class="material-icons right"></i>
                                            </button>
                                            <a class="btn waves-effect red" href="{% url 'Panel:Panel' %}"
                                               name="action">Cancelar
                                                <i class="material-icons right"></i>
                                            </a>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    {% else %}
                        <h4 class="center-align">Por favor registra un automovil primero</h4>
                    {% endif %}

                </div>
            </div>
        {% else %}
            <div class="main" style="padding: 50px 0 50px 0">
                <div class="row">
                    <div class="col s12 m7">
                        <div id="map"></div>
                    </div>
                    <div class="col s12 m5">
                        <a id="solicitar-btn" class="waves-effect light-blue btn">Solicitar</a>
                        <p class="route-name">
                            {{ route.name }}
                        </p>
                        <p class="info-text">
                            <i class="fa fa-map-marker" aria-hidden="true"></i> Referencia de
                            origen: {{ route.origin }}
                        </p>
                        <p class="info-text">
                            <i class="fa fa-map-marker" aria-hidden="true"></i> Destino: {{ destiny.name }}
                        </p>
                        <p class="info-text">
                            {% for car in user_cars %}
                                <i class='fa fa-car'
                                   aria-hidden='true'></i> Autom&oacute;vil: Marca {{ car.brand }}, modelo
                                {{ car.model }},
                                color
                                {{ car.color }}
                            {% endfor %}
                        </p>
                        <p class="info-text">
                            <i class="fa fa-calendar" aria-hidden="true"></i> Dias disponible: <br>
                        <ul style="padding-left: 15px">
                            {% for day in route_days %}
                                <li class='info-text'>{{ day.day }}</li>
                            {% endfor %}
                        </ul>
                        </p>
                    </div>
                </div>
            </div>

        {% endif %}

    </div>

{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        $(function () {
            $('#datetimepicker3').datetimepicker({
                format: 'LT'
            });
        });
    </script>
    <script type="text/javascript">
        var campus_list = [];
        {% for campus in campus_list %}
            var campus_obj = {
                "pk": {{ campus.pk }},
                "name": "{{ campus.name }}",
                "points": "{{ campus.latitude }},{{ campus.longitude }}",
                "latitude": "{{ campus.latitude }}",
                "longitude": "{{ campus.longitude }}"
            };
            campus_list.push(campus_obj);
        {% endfor %}

    </script>
    <script>
        var wayPoints = [];
        {% if route_markers %}
            {% for marker in route_markers %}

                wayPoints.push({
                    location: "{{ marker.latitude }}, {{ marker.longitude }}",
                    stopover: false
                });

            {% endfor %}

            {% if is_owner %}
                campus_pk = document.getElementById('destiny').value;
            {% else %}
                campus_pk = "{{ destiny.pk }}";
            {% endif %}

            for (var i = 0; i < campus_list.length; i++) {
                if (campus_list[i].pk == campus_pk) {
                    wayPoints.push({
                        location: "" + campus_list[i].latitude + ", " + campus_list[i].longitude,
                        stopover: false
                    });
                }
            }
        {% endif %}
    </script>
    <script type="text/javascript">
        var markerArray = [];
        var markerPosition = 1;
        var googleMarkersArray = [];
        var route_ok = false;
        var map;
        var directionsService;
        var directionsDisplay;

        function initMap() {
            directionsService = new google.maps.DirectionsService;
            directionsDisplay = new google.maps.DirectionsRenderer;

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: {lat: 41.85, lng: -87.65}
            });

            directionsDisplay.setMap(map);
            var infoWindow = new google.maps.InfoWindow({map: map});

            // Try HTML5 geolocation.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(pos);
                }, function () {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                handleLocationError(false, infoWindow, map.getCenter());
            }

            var onChangeHandler = function () {
                //setMapOnAll(null);

                //TODO: Ajax Request for save data in Database
                //sendRouteDataToServer();
                calculateAndDisplayRoute(directionsService, directionsDisplay);
                route_ok = true;
            };

            {% if is_owner %}
                document.getElementById('draw-btn').addEventListener('click', onChangeHandler);
                document.getElementById('guardar-btn').addEventListener('click', sendRouteDataToServer);
            {% endif %}

            map.addListener('click', function (click) {
                console.log("Click: " + click.latLng);
                var newMarker = new google.maps.Marker({
                    position: click.latLng,
                    map: map,
                    title: 'Marcador'
                });
                newMarker.addListener('click', function () {
                    newMarker.setVisible(false);
                    deleteMarker(newMarker);
                });
                wayPoints.push({
                    location: newMarker.getPosition(),
                    stopover: false
                });
                console.log("New marker: " + newMarker.getPosition());
                var markerObject = {
                    position: markerPosition,
                    latitud: newMarker.getPosition().lat(),
                    longitud: newMarker.getPosition().lng()
                };
                markerArray.push(markerObject);
                googleMarkersArray.push(newMarker);
                markerPosition++;
            });

            {% if is_owner %}
                $('#clean-btn').on("click", function () {
                    deleteMarkers();
                    directionsDisplay.setMap(null);
                });
            {% endif %}
            google.maps.event.addListenerOnce(map, 'tilesloaded', function () {
                calculateAndDisplayRoute(directionsService, directionsDisplay);
            });
        }

        function calculateAndDisplayRoute(directionsService, directionsDisplay) {
            destination = "";

            {% if is_owner %}
                campus_pk = document.getElementById('destiny').value;
            {% else %}
                campus_pk = "{{ destiny.pk }}";
            {% endif %}
            for (var i = 0; i < campus_list.length; i++) {
                if (campus_list[i].pk == campus_pk) {
                    destination = campus_list[i].points;
                    var markerObject = {
                        position: markerPosition++,
                        latitud: campus_list[i].latitude,
                        longitud: campus_list[i].longitude
                    };
                    markerArray.push(markerObject);
                    console.log(destination)
                }
            }

            directionsService.route({
                origin: wayPoints[0].location,
                destination: destination,
                waypoints: wayPoints,
                travelMode: google.maps.TravelMode.DRIVING
            }, function (response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
            directionsDisplay.setMap(map);
            route_ok = true;
        }

        function sendRouteDataToServer() {
            var dias = [];

            var origen = $('#origen').val();
            var destino = $('#destiny').val();
            var vehiculo = $('#car').val();
            var cupo = $('#sits').val();
            var horario = $('#hora').val();

            $('input[name="dia[]"]:checked').each(function () {
                dias.push($(this).val());
            });

            if ($('input[name="dia[]"]:checked').length > 0) {
                if (origen != "" && destino != "" && vehiculo != "" && cupo != "" && horario != "" && route_ok) {
                    $.ajax({
                        url: '/panel/update_route/',  //Server script to process data
                        type: 'post',
                        success: function (data) {
                            console.log(data);
                            if (data != "-1") {
                                routeId = data;
                                console.log("ID RUTA AJAX " + routeId);
                                console.log(markerArray);
                                if (markerArray.length > 0) {
                                    $.ajax({
                                        url: '/panel/save_markers/',  //Server script to process data
                                        type: 'post',
                                        success: function (data) {
                                            console.log(data);
                                            deleteMarkers();
                                        },
                                        error: function (message) {
                                            console.log(message);
                                        },
                                        // Form data
                                        data: {
                                            'routePk': routeId,
                                            'markers_json': JSON.stringify(markerArray)
                                        }
                                    });
                                    sweetAlert({
                                        title: "Correcto",
                                        text: "Ruta guardada correctamente",
                                        type: "success",
                                        closeOnConfirm: false
                                    }, function () {
                                        window.location.href = "/panel/route_list/";
                                    });
                                } else {
                                    sweetAlert("Error", "Por favor trace una ruta", "error");
                                }
                            }
                        },
                        error: function (message) {
                            console.log(message);
                        },
                        // Form data
                        data: {
                            'routePk': "{{ route.pk }}",
                            'origen': origen,
                            'destiny': destino,
                            'car': vehiculo,
                            'sits': cupo,
                            'time': horario,
                            'day': dias
                        }
                    });
                } else {
                    if (!route_ok) {
                        sweetAlert("Error", "Por favor traze la ruta y asegurese que es la correcta", "error");
                    } else {
                        sweetAlert("Error", "Por favor llene todos los campos", "error");
                    }
                }
            } else {
                sweetAlert("Error", "Por favor seleccione el dia de la semana que estará disponible esta ruta", "error");
            }
        }

        function deleteMarker(markerToDelete) {
            var temp_marker_array = [];
            var temp_wayPoints = [];
            var temp_googleMarkersArray = [];

            for (var i = 0; i < markerArray.length; i++) {
                if (markerArray[i].latitud != markerToDelete.getPosition().lat() && markerArray[i].longitud != markerToDelete.getPosition().lng()) {
                    temp_marker_array.push(markerArray[i]);
                    temp_wayPoints.push(wayPoints[i]);
                    temp_googleMarkersArray.push(googleMarkersArray[i]);
                } else {
                    console.log("Marker to delete found");
                }
            }

            wayPoints = temp_wayPoints;
            markerArray = temp_marker_array;
            googleMarkersArray = temp_googleMarkersArray;
        }

        // Sets the map on all markers in the array.
        function setMapOnAll(map) {
            if (!route_ok) {
                for (var i = 0; i < markerArray.length; i++) {
                    googleMarkersArray[i].setMap(map);
                }
            } else {
                for (var i = 0; i < markerArray.length - 1; i++) {
                    googleMarkersArray[i].setMap(map);
                }
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setMapOnAll(null);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
            clearMarkers();
            markerArray = [];
            wayPoints = [];
            googleMarkersArray = [];
            route_ok = false;
        }

    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCW7jLIOGjbN7K1lle9LrUaPruKD8dv_x0&callback=initMap">
    </script>
    <script>
        var window_height = $(window).height();
        var main_content_height = $(".main").height();

        if (window_height > main_content_height) {
            var navbar_height = $("#navbar").height();
            var footer_height = $("#footer").height();

            $("#map").css("height", window_height - navbar_height - footer_height + "px");
        }

        $(document).ready(function () {
            $('select').material_select();
        });

    </script>

    {% if not is_owner %}
        <script type="text/javascript">
            $('#solicitar-btn').on("click", function () {
                requestRoute();
            });

            function requestRoute() {
                $.ajax({
                    url: '/panel/make_notification/',  //Server script to process data
                    type: 'post',
                    success: function (data) {
                        if (data == 1) {
                            sweetAlert("Correcto", "La solicitud se ha hecho correctamente", "success");
                        } else {
                            sweetAlert("Alto", "Ya has solicitado esta ruta", "warning");
                        }
                    },
                    error: function (message) {
                        console.log(message);
                    },
                    // Form data
                    data: {
                        'route_pk': "{{ route.pk }}"
                    }
                });
            }

            //DESTINY MARKER SECTION

            var destiny_marker = null;

            $('#destiny').change(function () {
                var campus_pk = $('#destiny').val();
                console.log(campus_pk);
                console.log(campus_list.length);
                switch (campus_pk) {
                    {% for campus in campus_list %}
                        case '{{ campus.pk }}':
                            for (var i = 0; i < campus_list.length; i++) {
                                console.log("pk" + campus_list[i].pk);
                                if (campus_list[i].pk == {{ campus.pk }}) {
                                    latLng = new google.maps.LatLng({
                                        lat: Number(campus_list[i].latitude),
                                        lng: Number(campus_list[i].longitude)
                                    });
                                    destiny_marker = new google.maps.Marker({
                                        position: latLng,
                                        map: map,
                                        label: {
                                            color: 'black',
                                            fontWeight: 'bold',
                                            text: 'Destino'
                                        },
                                        icon: {
                                            url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                                            labelOrigin: new google.maps.Point(11, 40)
                                        }
                                    });
                                    map.setCenter(latLng);
                                }
                            }
                            break;
                    {% endfor %}
                    default:
                        break;
                }
            });
        </script>
    {% endif %}

{% endblock %}